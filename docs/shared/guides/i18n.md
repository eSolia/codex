# Internationalization (i18n) Guide

All eSolia apps support bilingual content in English (en) and Japanese (ja).

**Applies to:** Pulse, Periodic, Courier, Chocho, Nexus

## Language Detection Priority

The language is detected using this priority order:

1. **User Preference (Logged In)** - Saved `preferred_lang` from database
2. **Cookie** - User's explicit language choice (e.g., `lang`, `pulse_lang`)
3. **Accept-Language Header** - Browser's language preference with q-value priority
4. **Default** - English (`en`)

## Accept-Language Parsing

**CRITICAL**: The Accept-Language header must be parsed with proper q-value priority.

### Correct Implementation

```typescript
function detectLanguage(
  request: Request,
  cookies: { get: (name: string) => string | undefined }
): 'en' | 'ja' {
  // 1. Check cookie first (explicit user preference)
  const langCookie = cookies.get('lang');
  if (langCookie === 'ja' || langCookie === 'en') {
    return langCookie;
  }

  // 2. Parse Accept-Language header with q-value priority
  const acceptLang = request.headers.get('accept-language');
  if (acceptLang) {
    // Parse each language with its quality value
    const languages = acceptLang.split(',').map((part) => {
      const [lang, qPart] = part.trim().split(';');
      const q = qPart ? parseFloat(qPart.replace('q=', '')) : 1.0;
      return { lang: lang.toLowerCase(), q };
    });

    // Sort by quality value (highest first)
    languages.sort((a, b) => b.q - a.q);

    // Find first matching language in priority order
    for (const { lang } of languages) {
      if (lang.startsWith('ja')) return 'ja';
      if (lang.startsWith('en')) return 'en';
    }
  }

  // 3. Default to English
  return 'en';
}
```

### Why Q-Value Parsing Matters

The Accept-Language header includes quality values (q) that indicate preference:

```
Accept-Language: en-US,en;q=0.9,ja;q=0.8
```

This means:

- `en-US` has implicit q=1.0 (highest priority)
- `en` has q=0.9
- `ja` has q=0.8 (lowest priority)

**Wrong approach** (previously used):

```typescript
// DON'T DO THIS - checks for presence, not priority
if (acceptLang.includes('ja')) return 'ja';
```

This would return Japanese even when English is the user's primary preference.

**Correct approach**: Parse q-values, sort by priority, then find the first supported language.

## Implementation by App

### SvelteKit Apps (Pulse, Periodic, Courier, Chocho)

**Server-side** (`src/hooks.server.ts`):

```typescript
// Detect language in handle hook
const lang = detectLanguage(event.request, event.cookies);
event.locals.lang = lang;
```

**Client-side** (`src/lib/stores/language.ts`):

```typescript
import { writable, get } from 'svelte/store';

type Language = 'en' | 'ja';

function createLanguageStore() {
  const { subscribe, set, update } = writable<Language>('en');

  return {
    subscribe,
    set: (lang: Language) => {
      // Set cookie with 1 year expiry
      document.cookie = `lang=${lang}; path=/; max-age=31536000; SameSite=Lax`;
      set(lang);
    },
    toggle: () => {
      update((current) => {
        const next = current === 'en' ? 'ja' : 'en';
        document.cookie = `lang=${next}; path=/; max-age=31536000; SameSite=Lax`;
        return next;
      });
    },
    init: (serverLang: Language, userPref?: Language) => {
      // Priority: user preference > server-detected
      set(userPref || serverLang);
    },
  };
}

export const language = createLanguageStore();
```

### Hono Apps (Nexus)

**Utility function** (`src/lib/utils.ts`):

```typescript
export function detectLanguageFromHeader(acceptLanguage: string | null | undefined): 'en' | 'ja' {
  if (!acceptLanguage) return 'en';

  const languages = acceptLanguage.split(',').map((part) => {
    const [lang, qPart] = part.trim().split(';');
    const q = qPart ? parseFloat(qPart.replace('q=', '')) : 1.0;
    return { lang: lang.toLowerCase(), q };
  });

  languages.sort((a, b) => b.q - a.q);

  for (const { lang } of languages) {
    if (lang.startsWith('ja')) return 'ja';
    if (lang.startsWith('en')) return 'en';
  }

  return 'en';
}
```

**Usage in routes**:

```typescript
import { detectLanguageFromHeader } from '../../lib/utils';

app.get('/', (c) => {
  const lang = detectLanguageFromHeader(c.req.header('Accept-Language'));
  return c.html(renderPage(lang));
});
```

## Translation Files

### Structure

Translations are typically stored in `src/lib/i18n/translations.ts`:

```typescript
export const translations = {
  en: {
    nav: {
      dashboard: 'Dashboard',
      settings: 'Settings',
    },
    common: {
      save: 'Save',
      cancel: 'Cancel',
    },
  },
  ja: {
    nav: {
      dashboard: 'ダッシュボード',
      settings: '設定',
    },
    common: {
      save: '保存',
      cancel: 'キャンセル',
    },
  },
} as const;

export type TranslationKey = keyof (typeof translations)['en'];
```

### Usage in Components

```svelte
<script lang="ts">
  import { translations } from '$lib/i18n/translations';
  import { language } from '$lib/stores/language';

  $: t = translations[$language];
</script>

<button>{t.common.save}</button>
```

## Database Content

Bilingual database fields follow the pattern:

| Field         | Japanese Field   |
| ------------- | ---------------- |
| `name`        | `name_ja`        |
| `title`       | `title_ja`       |
| `description` | `description_ja` |

### Helper Function

```typescript
export function localize<T extends { name: string; name_ja?: string | null }>(
  item: T,
  lang: 'en' | 'ja'
): string {
  if (lang === 'ja' && item.name_ja) {
    return item.name_ja;
  }
  return item.name;
}
```

### SQL Queries

```sql
-- Select with both languages
SELECT
  id,
  name,
  name_ja,
  description,
  description_ja
FROM controls
WHERE id = ?;
```

## UI Patterns

### Language Toggle Button

```svelte
<script lang="ts">
  import { language } from '$lib/stores/language';
</script>

<button on:click={() => language.toggle()}>
  {$language === 'en' ? '日本語' : 'English'}
</button>
```

### URL Sharing

When sharing URLs like `https://pulse.esolia.co.jp/`:

- Visitors with Japanese browser settings see Japanese
- Visitors with English browser settings see English
- Either can click the toggle to switch
- Their preference is remembered via cookie

## Testing Language Detection

```typescript
// Test cases for Accept-Language parsing
const testCases = [
  { header: 'en-US,en;q=0.9,ja;q=0.8', expected: 'en' },
  { header: 'ja,en-US;q=0.9,en;q=0.8', expected: 'ja' },
  { header: 'ja-JP', expected: 'ja' },
  { header: 'fr-FR,fr;q=0.9,en;q=0.8,ja;q=0.7', expected: 'en' },
  { header: '', expected: 'en' },
];
```

## Common Mistakes

1. **Using `includes('ja')`** - Checks presence, not priority
2. **Not parsing q-values** - Treats all languages as equal priority
3. **Case sensitivity** - Language tags should be compared case-insensitively
4. **Missing cookie fallback** - Always check explicit user preference first
5. **Not handling partial matches** - `ja-JP` should match `ja`
