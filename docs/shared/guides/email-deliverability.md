# Email Headers for Deliverability

Reference guide for email headers that influence delivery rates when sending via Maileroo API. Use this as the canonical reference for all eSolia applications.

## Quick Reference: Transactional Email Headers

For PIN codes, password resets, notifications, and other transactional emails:

```typescript
headers: {
  // Required for transactional mail
  'Auto-Submitted': 'auto-generated',        // RFC 3834 - legitimate automated mail
  'X-Auto-Response-Suppress': 'All',         // Microsoft - suppress OOF/auto-replies

  // Recommended
  'X-Entity-Ref-ID': `unique-per-message`,   // Prevent Gmail conversation collapsing

  // For threading (if replying to user's email)
  'In-Reply-To': originalMessageId,          // Thread with original email
  'References': originalMessageId,           // Alternative threading header
}
```

**Do NOT include** on transactional mail:

- `List-Unsubscribe` — Signals marketing mail
- `Precedence: bulk` — Misrepresents mail type

---

## Maileroo API v2 Implementation

### Standard Transactional Email

```typescript
const response = await fetch('https://smtp.maileroo.com/api/v2/emails', {
  method: 'POST',
  headers: {
    'X-API-Key': env.MAILEROO_API_KEY,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    from: {
      address: 'noreply@your-domain.co.jp',
      display_name: 'Your App Name'
    },
    to: {
      address: recipientEmail,
      display_name: recipientName // Optional
    },
    subject: emailSubject,
    html: htmlContent,
    plain: plainTextContent,
    reply_to: {
      address: replyToEmail ?? 'support@your-domain.co.jp'
    },
    tracking: { clicks: false, opens: false }, // Disable for transactional
    headers: {
      'Auto-Submitted': 'auto-generated',
      'X-Auto-Response-Suppress': 'All',
      'X-Entity-Ref-ID': `txn-${shareId}-${Date.now()}`
      // Add your app-specific forensic headers here
    }
  })
});
```

### Threaded Email (Reply to User's Email)

When sending a follow-up email that should thread with the user's original:

```typescript
headers: {
  'Auto-Submitted': 'auto-generated',
  'X-Auto-Response-Suppress': 'All',
  'X-Entity-Ref-ID': `pin-${shareId}-${Date.now()}`,

  // Threading - use the Message-ID from the original email
  'In-Reply-To': originalMessageId,   // e.g., '<ABC123@mail.example.com>'
  'References': originalMessageId,

  // Your forensic headers
  'X-YourApp-Share-Id': shareId,
  'X-YourApp-Timestamp': new Date().toISOString(),
}
```

**Important**: Capture the `Message-ID` header from inbound emails if you need threading.

---

## Header Reference

### Authentication Headers (DNS-based)

These are generated by receiving servers—you don't set them directly, but your DNS records determine pass/fail.

| Header                   | Source                  | Purpose                                |
| ------------------------ | ----------------------- | -------------------------------------- |
| `Authentication-Results` | Receiving MTA           | SPF, DKIM, DMARC verdict               |
| `ARC-*` (3 headers)      | Intermediate forwarders | Preserves auth through forwarding      |
| `DKIM-Signature`         | Sending MTA (Maileroo)  | Message integrity and domain ownership |

### Transactional Mail Headers

| Header                     | Value               | Purpose                                                     |
| -------------------------- | ------------------- | ----------------------------------------------------------- |
| `Auto-Submitted`           | `auto-generated`    | RFC 3834 - signals legitimate automated mail                |
| `X-Auto-Response-Suppress` | `All`               | Microsoft ecosystem - suppresses OOF/auto-replies           |
| `X-Entity-Ref-ID`          | Unique per message  | Prevents Gmail from collapsing separate emails into threads |
| `In-Reply-To`              | Original Message-ID | Enables email threading                                     |
| `References`               | Original Message-ID | Alternative threading (some clients prefer this)            |

### Marketing/Bulk Mail Headers

For newsletters, campaigns, etc. (not PIN emails):

| Header                  | Value                         | Purpose                                |
| ----------------------- | ----------------------------- | -------------------------------------- |
| `List-Unsubscribe`      | `<mailto:...>, <https://...>` | Required since Feb 2024 (Google/Yahoo) |
| `List-Unsubscribe-Post` | `List-Unsubscribe=One-Click`  | Enables one-click unsubscribe button   |
| `Feedback-ID`           | `campaign:client:type:sender` | Google Postmaster Tools analytics      |
| `List-Id`               | `<list-name.domain>`          | Identifies mailing list                |
| `Precedence`            | `bulk`                        | Suppresses auto-replies                |

### Headers That Don't Help

Ignored by modern filters due to spam abuse:

- `X-Priority` / `X-MSMail-Priority`
- `Importance`
- `X-Mailer`

---

## Mail Type Classification

| Mail Type               | Transactional? | Include Unsubscribe? |
| ----------------------- | -------------- | -------------------- |
| PIN/access code         | Yes            | No                   |
| Password reset          | Yes            | No                   |
| Order confirmation      | Yes            | No                   |
| Shipping notification   | Yes            | No                   |
| Monthly statement       | Yes            | No                   |
| Account alerts          | Yes            | No                   |
| "Items left in cart"    | No             | Yes                  |
| "Review your purchase"  | Borderline     | Probably yes         |
| Product recommendations | No             | Yes                  |
| Newsletter              | No             | Yes                  |

---

## Infrastructure Best Practices

### Stream Separation

Separate transactional and marketing mail:

```
transactional.example.co.jp  →  PIN codes, password resets, alerts
marketing.example.co.jp      →  newsletters, campaigns
```

Benefits:

- Marketing reputation can't poison transactional delivery
- Different DMARC policies if needed
- Cleaner monitoring per stream

### Dedicated IP Considerations

| Volume           | Shared Pool              | Dedicated IP              |
| ---------------- | ------------------------ | ------------------------- |
| < 1,000/day      | Inherits pool reputation | No reputation; cold start |
| 1,000–50,000/day | Provider-dependent       | Requires warming period   |
| > 50,000/day     | Risk of noisy neighbors  | Full control              |

Stick with Maileroo's shared pool unless:

- Volume exceeds ~10,000/month sustained
- Compliance requires IP isolation
- Delivery problems trace to shared pool

### DNS Requirements

Ensure your sending domain has:

- **SPF record** including Maileroo's servers
- **DKIM public key** (configured in Maileroo dashboard)
- **DMARC policy** with alignment passing

---

## eSolia App Reference Implementations

### Forensic Header Naming Convention

Each eSolia app should use consistent header naming for audit trails:

```
X-{AppName}-Version     # App version for debugging
X-{AppName}-Timestamp   # ISO 8601 timestamp
X-{AppName}-Request-Id  # Unique request/transaction ID
X-{AppName}-Signature   # HMAC signature for integrity (optional)
```

**App-specific prefixes:**

| App      | Header Prefix | Example               |
| -------- | ------------- | --------------------- |
| Nexus    | `X-Nexus-`    | `X-Nexus-Share-Id`    |
| Pulse    | `X-Pulse-`    | `X-Pulse-Report-Id`   |
| Periodic | `X-Periodic-` | `X-Periodic-Check-Id` |
| Courier  | `X-Courier-`  | `X-Courier-Share-Id`  |

### Generic Implementation Pattern

```typescript
// src/lib/email.ts (adapt per app)
interface SendEmailOptions {
  to: { address: string; display_name?: string };
  subject: string;
  html: string;
  plain: string;
  replyTo?: string;
  inReplyTo?: string;
  forensicData?: Record<string, string>;
}

export async function sendEmail(
  env: Env,
  options: SendEmailOptions
): Promise<{ success: boolean; messageId?: string }> {
  const APP_NAME = 'YourApp'; // Nexus, Pulse, Periodic, Courier
  const timestamp = new Date().toISOString();

  const customHeaders: Record<string, string> = {
    // Required transactional headers
    'Auto-Submitted': 'auto-generated',
    'X-Auto-Response-Suppress': 'All',
    'X-Entity-Ref-ID': `${APP_NAME.toLowerCase()}-${crypto.randomUUID()}`,

    // App forensic headers
    [`X-${APP_NAME}-Version`]: env.APP_VERSION,
    [`X-${APP_NAME}-Timestamp`]: timestamp,
    ...options.forensicData
  };

  // Email threading
  if (options.inReplyTo) {
    customHeaders['In-Reply-To'] = options.inReplyTo;
    customHeaders['References'] = options.inReplyTo;
  }

  const payload = {
    from: {
      address: `noreply@${APP_NAME.toLowerCase()}.esolia.co.jp`,
      display_name: `eSolia ${APP_NAME}`
    },
    to: options.to,
    subject: options.subject,
    html: options.html,
    plain: options.plain,
    reply_to: { address: options.replyTo ?? 'support@esolia.co.jp' },
    tracking: { clicks: false, opens: false },
    headers: customHeaders
  };

  const response = await fetch('https://smtp.maileroo.com/api/v2/emails', {
    method: 'POST',
    headers: {
      'X-API-Key': env.MAILEROO_API_KEY,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  });

  if (!response.ok) {
    console.error('Email send failed:', await response.text());
    return { success: false };
  }

  const result = await response.json();
  return { success: true, messageId: result.message_id };
}
```

### Nexus-Specific: PIN Delivery with Queue

Nexus uses Cloudflare Queues for delayed PIN delivery:

```typescript
// Nexus src/lib/email.ts - specific implementation
const customHeaders: Record<string, string> = {
  'Auto-Submitted': 'auto-generated',
  'X-Auto-Response-Suppress': 'All',
  'X-Entity-Ref-ID': `pin-${shareId}-${Date.now()}`,

  // Nexus-specific forensic headers
  'X-Nexus-Version': env.APP_VERSION,
  'X-Nexus-Timestamp': timestamp,
  'X-Nexus-Share-Id': shareId,
  'X-Nexus-Queue-Id': queueId,
  'X-Nexus-Triggered-At': triggeredAt,
  'X-Nexus-Signature': hmacSignature // For integrity verification
};
```

### Periodic-Specific: Check Result Notifications

```typescript
// Periodic - check result alert headers
const customHeaders: Record<string, string> = {
  'Auto-Submitted': 'auto-generated',
  'X-Auto-Response-Suppress': 'All',
  'X-Entity-Ref-ID': `check-${checkId}-${Date.now()}`,

  'X-Periodic-Version': env.APP_VERSION,
  'X-Periodic-Check-Id': checkId,
  'X-Periodic-Domain': domain,
  'X-Periodic-Check-Type': checkType // dns, dmarc, ssl, etc.
};
```

### Courier-Specific: Share Notifications

```typescript
// Courier - file share notification headers
const customHeaders: Record<string, string> = {
  'Auto-Submitted': 'auto-generated',
  'X-Auto-Response-Suppress': 'All',
  'X-Entity-Ref-ID': `share-${shareId}-${Date.now()}`,

  'X-Courier-Version': env.APP_VERSION,
  'X-Courier-Share-Id': shareId,
  'X-Courier-Org-Id': orgId
};
```

---

## Maileroo API Reference

- **Endpoint**: `https://smtp.maileroo.com/api/v2/emails`
- **Auth Header**: `X-API-Key: your-api-key`
- **Docs**: [Maileroo Send Email API](https://maileroo.com/docs/email-api/send-basic-email)

---

_Last updated: December 2025_
_Canonical source: nexus/docs/design/email-headers-deliverability.md_
